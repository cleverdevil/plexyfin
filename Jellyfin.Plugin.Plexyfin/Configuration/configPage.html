<!DOCTYPE html>
<html>
<head>
    <title>Plexyfin</title>
    <style>
        .section-title {
            margin-top: 1.5em;
            color: #52B54B;
            font-weight: bold;
        }
        .fieldDescription {
            margin-top: 0.5em;
            margin-bottom: 1em;
            color: #888;
        }
        .checkboxContainer {
            margin-top: 1em;
            margin-bottom: 1em;
        }
        h1 {
            color: #52B54B;
        }
        .section-divider {
            border-top: 1px solid #ccc;
            margin-top: 2em;
            margin-bottom: 1em;
        }
    </style>
</head>
<body>
    <div id="Plexyfin" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <h1>Plexyfin Configuration</h1>
                <form class="plexifinConfigurationForm">
                    <!-- Plex Server Configuration Section -->
                    <div class="section-title">Plex Server Configuration</div>
                    <div class="fieldDescription">
                        Configure the connection to your Plex Media Server. This is required for syncing collections and other data.
                    </div>
                    
                    <div class="inputContainer">
                        <label for="PlexServerUrl">Plex Server URL:</label>
                        <input id="PlexServerUrl" name="PlexServerUrl" type="text" 
                               placeholder="http://plexserver:32400" required />
                        <div class="fieldDescription">
                            Enter the URL to your Plex Media Server, including port number (e.g., http://192.168.1.100:32400)
                        </div>
                    </div>
                    
                    <div class="inputContainer">
                        <label for="PlexApiToken">Plex API Token:</label>
                        <input id="PlexApiToken" name="PlexApiToken" type="password" required />
                        <div class="fieldDescription">
                            Enter your Plex API Token. You can find this by following the instructions 
                            <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank">here</a>.
                        </div>
                    </div>
                    
                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" id="SyncCollections" />
                            <span>Sync Collections from Plex</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, collections from Plex will be created in Jellyfin during sync.
                        </div>
                    </div>
                    
                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" id="SyncPlaylists" />
                            <span>Sync Playlists from Plex</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, playlists from Plex will be created in Jellyfin during sync.
                        </div>
                    </div>
                    
                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" id="DeleteBeforeSync" />
                            <span>Delete Existing Collections Before Syncing</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, all existing collections in Jellyfin will be deleted before syncing from Plex.
                            This ensures there are no duplicate or stale collections from previous sync operations.
                        </div>
                    </div>
                    
                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" id="SyncArtwork" />
                            <span>Sync Collection Artwork</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, collection posters and backdrops will be synced from Plex to Jellyfin.
                        </div>
                    </div>
                    
                    <div class="section-title">Scheduled Sync</div>
                    <div class="fieldDescription">
                        Configure automatic synchronization from Plex to Jellyfin on a schedule.
                    </div>
                    
                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" id="EnableScheduledSync" />
                            <span>Enable Scheduled Sync</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, collections and playlists will be automatically synced on the schedule below.
                        </div>
                    </div>
                    
                    <div class="inputContainer">
                        <label for="SyncIntervalHours">Sync Interval (Hours):</label>
                        <input id="SyncIntervalHours" name="SyncIntervalHours" type="number" min="1" max="168" step="1" />
                        <div class="fieldDescription">
                            How often to sync from Plex (in hours). Minimum 1 hour, maximum 168 hours (1 week).
                        </div>
                    </div>
                    
                    <button is="emby-button" type="button" class="raised button-submit" id="btnSaveConfig">
                        <span>Save Settings</span>
                    </button>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Collection Management Section -->
                    <div class="section-title">Collection Management</div>
                    <div class="fieldDescription">
                        Tools for managing collections and syncing with Plex.
                    </div>
                    
                    <div class="inputContainer">
                        <label for="CollectionName">Test Collection Name:</label>
                        <input id="CollectionName" name="CollectionName" type="text" />
                    </div>
                    
                    <div class="buttonContainer">
                        <button is="emby-button" type="button" class="raised" id="btnCreateCollection">
                            <span>Create Test Collection</span>
                        </button>
                        
                        <button is="emby-button" type="button" class="raised" id="btnSyncNow" style="margin-left: 10px;">
                            <span>Sync Now</span>
                        </button>
                    </div>
                    
                    <div class="fieldDescription">
                        "Create Test Collection" creates a collection with the specified name and adds all movies that start with 'A'.
                        <br/>
                        "Sync Now" starts a manual sync from Plex to Jellyfin using the configured settings.
                    </div>
                    
                    <br />
                    <div class="alert" id="saveResult"></div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var PlexyfindConfig = {
                pluginUniqueId: 'b9f0c474-e9a8-4292-ae41-eb3c1542f4cd'
            };

            document.querySelector('.plexifinConfigurationForm')
                .addEventListener('submit', function(e) {
                    e.preventDefault();
                    return false;
                });

            document.querySelector('#btnCreateCollection')
                .addEventListener('click', function() {
                    createCollection();
                });
                
            document.querySelector('#btnSaveConfig')
                .addEventListener('click', function() {
                    saveConfiguration();
                });
                
            document.querySelector('#btnSyncNow')
                .addEventListener('click', function() {
                    syncFromPlex();
                });

            function showMessage(message, isError) {
                const saveResultElem = document.querySelector('#saveResult');
                saveResultElem.innerText = message;
                if (isError) {
                    saveResultElem.classList.add('alert-danger');
                    saveResultElem.classList.remove('alert-success');
                } else {
                    saveResultElem.classList.add('alert-success');
                    saveResultElem.classList.remove('alert-danger');
                }
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    saveResultElem.innerText = '';
                    saveResultElem.classList.remove('alert-success', 'alert-danger');
                }, 5000);
            }

            function createCollection() {
                var config = {
                    CollectionName: document.querySelector('#CollectionName').value
                };

                Dashboard.showLoadingMsg();
                // Get the API key from the current dashboard session
                const apiKey = ApiClient.accessToken();
                
                ApiClient.fetch({
                    type: 'POST',
                    url: ApiClient.getUrl('/Plexyfin/CreateCollection'),
                    headers: {
                        'Authorization': `MediaBrowser Token="${apiKey}"`,
                        'X-Emby-Authorization': `MediaBrowser Token="${apiKey}"`
                    },
                    data: JSON.stringify(config),
                    contentType: 'application/json'
                }).then(function() {
                    Dashboard.hideLoadingMsg();
                    showMessage('Collection created successfully!', false);
                }, function(error) {
                    Dashboard.hideLoadingMsg();
                    showMessage('Error creating collection: ' + error.status + ' ' + error.statusText, true);
                });
            }
            
            function syncFromPlex() {
                Dashboard.showLoadingMsg();
                // Get the API key from the current dashboard session
                const apiKey = ApiClient.accessToken();
                
                ApiClient.fetch({
                    type: 'POST',
                    url: ApiClient.getUrl('/Plexyfin/SyncFromPlex'),
                    headers: {
                        'Authorization': `MediaBrowser Token="${apiKey}"`,
                        'X-Emby-Authorization': `MediaBrowser Token="${apiKey}"`
                    },
                    contentType: 'application/json'
                }).then(function(result) {
                    Dashboard.hideLoadingMsg();
                    showMessage('Sync completed successfully!', false);
                }, function(error) {
                    Dashboard.hideLoadingMsg();
                    showMessage('Error syncing from Plex: ' + error.status + ' ' + error.statusText, true);
                });
            }
            
            function saveConfiguration() {
                Dashboard.showLoadingMsg();
                
                // Get current configuration
                ApiClient.getPluginConfiguration(PlexyfindConfig.pluginUniqueId).then(function (config) {
                    // Update with new values from form
                    config.PlexServerUrl = document.querySelector('#PlexServerUrl').value;
                    config.PlexApiToken = document.querySelector('#PlexApiToken').value;
                    config.SyncCollections = document.querySelector('#SyncCollections').checked;
                    config.SyncPlaylists = document.querySelector('#SyncPlaylists').checked;
                    config.DeleteBeforeSync = document.querySelector('#DeleteBeforeSync').checked;
                    config.SyncArtwork = document.querySelector('#SyncArtwork').checked;
                    config.EnableScheduledSync = document.querySelector('#EnableScheduledSync').checked;
                    
                    // Parse the sync interval with validation
                    var syncInterval = parseInt(document.querySelector('#SyncIntervalHours').value);
                    if (isNaN(syncInterval) || syncInterval < 1) {
                        syncInterval = 24; // Default to 24 hours if invalid
                    } else if (syncInterval > 168) {
                        syncInterval = 168; // Cap at 168 hours (1 week)
                    }
                    config.SyncIntervalHours = syncInterval;
                    
                    config.CollectionName = document.querySelector('#CollectionName').value;
                    
                    // Save updated configuration
                    ApiClient.updatePluginConfiguration(PlexyfindConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        showMessage('Settings saved successfully!', false);
                    });
                });
            }

            // Load configuration from server
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(PlexyfindConfig.pluginUniqueId).then(function (config) {
                // Fill form with saved configuration
                document.querySelector('#PlexServerUrl').value = config.PlexServerUrl || '';
                document.querySelector('#PlexApiToken').value = config.PlexApiToken || '';
                document.querySelector('#SyncCollections').checked = config.SyncCollections;
                document.querySelector('#SyncPlaylists').checked = config.SyncPlaylists;
                document.querySelector('#DeleteBeforeSync').checked = config.DeleteBeforeSync;
                document.querySelector('#SyncArtwork').checked = config.SyncArtwork;
                document.querySelector('#EnableScheduledSync').checked = config.EnableScheduledSync;
                document.querySelector('#SyncIntervalHours').value = config.SyncIntervalHours || 24;
                document.querySelector('#CollectionName').value = config.CollectionName || 'Test Collection';
                Dashboard.hideLoadingMsg();
            });
        </script>
    </div>
</body>
</html>